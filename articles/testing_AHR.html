<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulation for testing average hazard ratio and sample size under non-proportional hazards • gsDesign2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Simulation for testing average hazard ratio and sample size under non-proportional hazards">
<meta property="og:description" content="gsDesign2">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gsDesign2</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Initial Version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AHRVignette.html">Average hazard ratio and sample size under non-proportional hazards</a>
    </li>
    <li>
      <a href="../articles/ArbitraryDistribution.html">Approximating an Arbitrary Survival Distribution</a>
    </li>
    <li>
      <a href="../articles/eEventsTheory.html">Computing expected events by interval at risk</a>
    </li>
    <li>
      <a href="../articles/testing_AHR.html">Simulation for testing average hazard ratio and sample size under non-proportional hazards</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="testing_AHR_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Simulation for testing average hazard ratio and sample size under non-proportional hazards</h1>
            
      
      
      <div class="hidden name"><code>testing_AHR.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gsDesign2</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gsDesign</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">simtrial</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></code></pre></div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This document demonstrates a simple simulation for unit testing of average hazard ratio function (). The details on calculating average hazard ratio is already available in <code>AHRVignette</code>, and the purpose of this vignette is to show how a simulation can be conducted in order to approximate the average hazard ratio. The results were used for unit test to see whether the simulation results could be good approximation of the actual results from .</p>
<p>The simulation is wrapped into a function which gives the users the flexibility the design assumptions. The simulations are based on targeted event only, but for other scenarios, similar approach can be taken.</p>
<div id="intial-setup" class="section level2">
<h2 class="hasAnchor">
<a href="#intial-setup" class="anchor"></a>Intial setup</h2>
<p>We begin by setting two parameters that will be used throughout in simulations used to verify accuracy of power approximations; either could be customized for each simulation. First, we set the number of simulations to be performed. You can increase this to improve accuracy of simulation estimates of power.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nsim</span> <span class="op">=</span> <span class="fl">2000</span>
<span class="va">block</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Experimental"</span>, <span class="st">"Control"</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>
<span class="va">strata</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
</div>
<div id="design-scenario" class="section level2">
<h2 class="hasAnchor">
<a href="#design-scenario" class="anchor"></a>Design scenario</h2>
<p>We set up the design parameters. Enrollment ramps up over the course of the first 4 months follow-up by a steady state enrollment thereafter. This will be adjusted proportionately to power the trial later. The control group has a piecewise exponential distribution with median 9 for the first 3 months and 18 thereafter. The hazard ratio of the experimental group versus control is 0.9 for the first 3 months followed by 0.6 thereafter.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">enrollRates</span><span class="op">=</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum<span class="op">=</span><span class="st">"All"</span>,
                           duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">10</span><span class="op">)</span>,
                           rate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">9</span><span class="op">)</span><span class="op">)</span>
<span class="va">failRates</span><span class="op">=</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum<span class="op">=</span><span class="st">"All"</span>,
                         duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">100</span><span class="op">)</span>,
                         failRate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">18</span><span class="op">)</span>,
                         hr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.9</span>,<span class="fl">.6</span><span class="op">)</span>,
                         dropoutRate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.001</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The Fleming-Harrington weights can be defined in case the users want to run any weighted logrank tests, and is defined as <code>rg</code> as follows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rg</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fl">0</span>, gamma <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>For this simulation, we consider the sample size and the events are given as <code>N</code> and <code>events</code> and the bounds for the interim analysis are provided as <code>bounds</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">=</span> <span class="va">enrollRates</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rate</span> <span class="op">*</span> <span class="va">duration</span><span class="op">)</span><span class="op">)</span>
<span class="va">events</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20.4</span>, <span class="fl">48.9</span>, <span class="fl">66.1</span><span class="op">)</span>
<span class="va">bounds</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,
                        upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.962588</span>, <span class="fl">2.359018</span>, <span class="fl">2.014084</span><span class="op">)</span>,
                        lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.05</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.1</span><span class="op">)</span>, <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The simulation for the average hazard ratio for <span class="math inline">\(k = 3\)</span> interim analysis can be then conducted as follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">K</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span>
<span class="va">fr</span> <span class="op">=</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/simfix2simPWSurv.html">simfix2simPWSurv</a></span><span class="op">(</span>failRates <span class="op">=</span> <span class="va">failRates</span><span class="op">)</span>
<span class="va">simresult</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsim</span><span class="op">)</span><span class="op">{</span>
  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/simPWSurv.html">simPWSurv</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                             enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,
                             failRates <span class="op">=</span> <span class="va">fr</span><span class="op">$</span><span class="va">failRates</span>,
                             dropoutRates <span class="op">=</span> <span class="va">fr</span><span class="op">$</span><span class="va">dropoutRates</span>,
                             strata <span class="op">=</span> <span class="va">strata</span>,
                             block <span class="op">=</span> <span class="va">block</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">e</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span>
    <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/getCutDateForCount.html">getCutDateForCount</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sim</span>, count <span class="op">=</span> <span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span><span class="op">)</span>
    <span class="va">ds</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">%&gt;%</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/cutData.html">cutData</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>
    <span class="va">res.cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">tte</span>, event <span class="op">=</span> <span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="va">Treatment</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html">strata</a></span><span class="op">(</span><span class="va">Stratum</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ds</span><span class="op">)</span>
    <span class="va">Cox.coef</span> <span class="op">&lt;-</span> <span class="va">res.cox</span><span class="op">$</span><span class="va">coefficients</span>
    <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/cutDataAtCount.html">cutDataAtCount</a></span><span class="op">(</span><span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># cut simulation for analysis at targeted events</span>
      <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/tensurv.html">tensurv</a></span><span class="op">(</span>txval <span class="op">=</span> <span class="st">"Experimental"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/tenFH.html">tenFH</a></span><span class="op">(</span>rg <span class="op">=</span> <span class="va">rg</span><span class="op">)</span>
    <span class="va">simresult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">simresult</span>,
                       <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="va">i</span>,
                              k <span class="op">=</span> <span class="va">e</span>,
                              Events <span class="op">=</span> <span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span>,
                              Z <span class="op">=</span> <span class="op">-</span><span class="va">Z</span><span class="op">$</span><span class="va">Z</span>,<span class="co"># Change sign for Z</span>
                              Time <span class="op">=</span> <span class="va">dt</span>,
                              Cox.coef <span class="op">=</span> <span class="va">Cox.coef</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">simresult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">simresult</span>, <span class="va">N</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
<span class="va">simresult</span></code></pre></div>
<p>After combining the simulation results they can be summarized with respect to the analysis time as</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simresult</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">bounds</span>, by <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'upper'</span>, <span class="st">'lower'</span><span class="op">)</span> ,key <span class="op">=</span> <span class="st">"Bounds"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">Bounds</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
              Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span>,
              AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Cox.coef</span><span class="op">)</span><span class="op">)</span>,
              z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
              Events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Bounds</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">Bounds</span>,<span class="va">Time</span>, <span class="va">Events</span>, <span class="va">AHR</span>,  <span class="va">z</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="putting-them-all-into-a-function" class="section level1">
<h1 class="hasAnchor">
<a href="#putting-them-all-into-a-function" class="anchor"></a>Putting them all into a function</h1>
<p>Finally, the whole simulation approach is wrapped into a function <code>sim_gsd</code> where the users can modify the design assumptions based on their desired design.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_gsd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nsim</span> <span class="op">=</span> <span class="fl">1000</span>,
                    <span class="va">block</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Experimental"</span>, <span class="st">"Control"</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span>,
                    <span class="va">strata</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                    <span class="va">enrollRates</span><span class="op">=</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum<span class="op">=</span><span class="st">"All"</span>,
                                               duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">10</span><span class="op">)</span>,
                                               rate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">6</span>,<span class="fl">9</span><span class="op">)</span><span class="op">)</span>,
                    <span class="va">failRates</span><span class="op">=</span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Stratum<span class="op">=</span><span class="st">"All"</span>,
                                             duration<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">100</span><span class="op">)</span>,
                                             failRate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">9</span>,<span class="fl">18</span><span class="op">)</span>,
                                             hr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.9</span>,<span class="fl">.6</span><span class="op">)</span>,
                                             dropoutRate<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.001</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
                    <span class="va">rg</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>rho <span class="op">=</span> <span class="fl">0</span>, gamma <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                    <span class="va">N</span> <span class="op">=</span> <span class="cn">NULL</span>,
                    <span class="co">#events = c(158.954, 200.636, 252.077),</span>
                    <span class="va">events</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20.4</span>, <span class="fl">48.9</span>, <span class="fl">66.1</span><span class="op">)</span>,
                    <span class="va">bounds</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,
                                            upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.962588</span>, <span class="fl">2.359018</span>, <span class="fl">2.014084</span><span class="op">)</span>,
                                            lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.05</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="fl">.1</span><span class="op">)</span>, <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span><span class="op">{</span>
  <span class="va">N</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>, <span class="va">enrollRates</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">rate</span> <span class="op">*</span> <span class="va">duration</span><span class="op">)</span><span class="op">)</span>, <span class="va">N</span> <span class="op">)</span>
  <span class="va">K</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span>
  <span class="va">fr</span> <span class="op">=</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/simfix2simPWSurv.html">simfix2simPWSurv</a></span><span class="op">(</span>failRates <span class="op">=</span> <span class="va">failRates</span><span class="op">)</span>
  <span class="va">simresult</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsim</span><span class="op">)</span><span class="op">{</span>
    <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/simPWSurv.html">simPWSurv</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
                               enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,
                               failRates <span class="op">=</span> <span class="va">fr</span><span class="op">$</span><span class="va">failRates</span>,
                               dropoutRates <span class="op">=</span> <span class="va">fr</span><span class="op">$</span><span class="va">dropoutRates</span>,
                               strata <span class="op">=</span> <span class="va">strata</span>,
                               block <span class="op">=</span> <span class="va">block</span><span class="op">)</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">e</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span>
      <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/getCutDateForCount.html">getCutDateForCount</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sim</span>, count <span class="op">=</span> <span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span><span class="op">)</span>
      <span class="va">ds</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">%&gt;%</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/cutData.html">cutData</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>
      <span class="va">res.cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">tte</span>, event <span class="op">=</span> <span class="va">event</span><span class="op">)</span><span class="op">~</span><span class="va">Treatment</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/strata.html">strata</a></span><span class="op">(</span><span class="va">Stratum</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ds</span><span class="op">)</span>
      <span class="va">Cox.coef</span> <span class="op">&lt;-</span> <span class="va">res.cox</span><span class="op">$</span><span class="va">coefficients</span>
      <span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">sim</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/cutDataAtCount.html">cutDataAtCount</a></span><span class="op">(</span><span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># cut simulation for analysis at targeted events</span>
        <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/tensurv.html">tensurv</a></span><span class="op">(</span>txval <span class="op">=</span> <span class="st">"Experimental"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/simtrial/man/tenFH.html">tenFH</a></span><span class="op">(</span>rg <span class="op">=</span> <span class="va">rg</span><span class="op">)</span>
      <span class="va">simresult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">simresult</span>,
                         <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="va">i</span>,
                                k <span class="op">=</span> <span class="va">e</span>,
                                Events <span class="op">=</span> <span class="va">events</span><span class="op">[</span><span class="va">e</span><span class="op">]</span>,
                                Z <span class="op">=</span> <span class="op">-</span><span class="va">Z</span><span class="op">$</span><span class="va">Z</span>,<span class="co"># Change sign for Z</span>
                                Time <span class="op">=</span> <span class="va">dt</span>,
                                Cox.coef <span class="op">=</span> <span class="va">Cox.coef</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="va">simresult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">simresult</span>, <span class="va">N</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">simresult</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">full_join</a></span><span class="op">(</span><span class="va">bounds</span>, by <span class="op">=</span> <span class="st">"k"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'upper'</span>, <span class="st">'lower'</span><span class="op">)</span> ,key <span class="op">=</span> <span class="st">"Bounds"</span>, value <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">Bounds</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,
              Time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Time</span><span class="op">)</span>,
              AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Cox.coef</span><span class="op">)</span><span class="op">)</span>,
              z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>,
              Events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">round</span>, digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">Bounds</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">k</span>, <span class="va">Bounds</span>,<span class="va">Time</span>, <span class="va">Events</span>, <span class="va">AHR</span>,  <span class="va">z</span><span class="op">)</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>Analysis <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">k</span>,
                        Bound <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">Bounds</span>,
                        Z <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">z</span>,
                        Time <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">Time</span>,
                        AHR <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">AHR</span>,
                        Events <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">Events</span><span class="op">)</span>

  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">N</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="op">}</span></code></pre></div>
<p>Here is a small simulation of size 10 to show the results of <code>sim_gsd</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sim_gsd</span><span class="op">(</span>nsim <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Keaven Anderson, Yilong Zhang. Site built with pkgdown 1.6.1.
  </p>
  <p>Copyright © 2021 Merck Sharp &amp; Dohme Corp., a subsidiary of Merck &amp; Co., Inc., Kenilworth, NJ, USA.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
