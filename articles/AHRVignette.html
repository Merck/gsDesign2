<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gsDesign2">
<title>Average hazard ratio and sample size under non-proportional hazards • gsDesign2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Average hazard ratio and sample size under non-proportional hazards">
<meta property="og:description" content="gsDesign2">
<meta property="og:image" content="https://merck.github.io/gsDesign2/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gsDesign2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/AHRVignette.html">Average hazard ratio and sample size under non-proportional hazards</a>
    <a class="dropdown-item" href="../articles/ArbitraryDistribution.html">Approximating an Arbitrary Survival Distribution</a>
    <a class="dropdown-item" href="../articles/eEventsTheory.html">Computing expected events by interval at risk</a>
    <a class="dropdown-item" href="../articles/testing_AHR.html">Simulation for testing average hazard ratio and sample size under non-proportional hazards</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/Merck/gsDesign2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Average hazard ratio and sample size under non-proportional hazards</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Merck/gsDesign2/blob/HEAD/vignettes/AHRVignette.Rmd" class="external-link"><code>vignettes/AHRVignette.Rmd</code></a></small>
      <div class="d-none name"><code>AHRVignette.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document demonstrates applications of the average hazard ratio concept in the design of fixed designs without interim analysis. Throughout we consider a 2-arm trial with an experimental and control group and a time-to-event endpoint. Testing for differences between treatment groups is performed using the stratified logrank test. In the above setting, the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> routine provides an average hazard ratio that can be used for sample size using the function <code><a href="https://keaven.github.io/gsDesign/reference/nSurv.html" class="external-link">gsDesign::nSurv()</a></code>. The approach assumes piecewise constant enrollment rates and piecewise exponential failure rates with the option of including multiple strata. This approach allows the flexibility to approximate a wide variety of scenarios. We evaluate the approximations used via simulation using the <strong>simtrial</strong> package; we specifically provide a simulation routine so that any changes specified by the user should be easily incorporated. We consider both non-proportional hazards for a single stratum and multiple strata with different underlying proportional hazards assumptions.</p>
<p>There are two things to note regarding differences between <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> and <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code>:</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> is less flexible in that it requires all strata are enrolled at the same relative rates throughout the trial whereas <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> allows, for example, enrollment to start or stop at different times in different strata. In this document, we use the more restrictive parameterization of <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> so that we can confirm the asymptotic sample size approximation based on <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> by simulation.</li>
<li>
<code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> provides more flexibility in test statistics used than <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> as documented in the pMaxCombo vignette demonstrating use of Fleming-Harrington weighted logrank tests and combinations of such tests.</li>
</ol>
<div class="section level3">
<h3 id="document-organization">Document organization<a class="anchor" aria-label="anchor" href="#document-organization"></a>
</h3>
<p>This vignette is organized as follows:</p>
<ul>
<li>Two non-proportional hazards examples are introduced for fixed sample size approximation, one with a single stratum and one with two strata.
<ul>
<li>The single stratum design assumes a delayed treatment benefit.</li>
<li>The stratified example assumes different proportional hazards in 3 strata.</li>
</ul>
</li>
<li>Each of these examples have the following subsections:
<ul>
<li>Decription of the design scenario.</li>
<li>Deriving an average hazard ratio.</li>
<li>Deriving sample size based on average hazard ratio.</li>
<li>Computing and plotting the average hazard ratio as a function of time.</li>
<li>Simulation to verify that the sample size approximation provides the targeted power.</li>
</ul>
</li>
</ul>
<p>Each simulation is done with data cutoff performed in 5 different ways:</p>
<ul>
<li>Based on targeted trial duration</li>
<li>Based on targeted minimum follow-up duration only</li>
<li>Based on targeted event count only</li>
<li>Based on the maximum of targeted event count and targeted trial duration</li>
<li>Based on the maximum of targeted event count and targeted minimum follow-up</li>
</ul>
<p>The method based on waiting to achieve targeted event count and targeted minimum follow-up appears to be both practical and to provide the targeted power.</p>
</div>
<div class="section level3">
<h3 id="intial-setup">Intial setup<a class="anchor" aria-label="anchor" href="#intial-setup"></a>
</h3>
<p>We begin by setting two parameters that will be used throughout in simulations used to verify accuracy of power approximations; either could be customized for each simulation. First, we set the number of simulations to be performed. You can increase this to improve accuracy of simulation estimates of power.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nsim</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span></code></pre></div>
<p>Simulations using the <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> routine below use blocked randomization. We set that here and do not change for individual simulations. Based on balanced randomization in <code>block</code> we set the randomization ratio of experimental to control to 1.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Experimental"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>We load packages needed below.</p>
<ul>
<li>
<strong>gsDesign</strong> is used for its implementation of the <span class="citation">Schoenfeld (1981)</span> approximation to compute the number of events required to power a trial under the proportional hazards assumption.</li>
<li>
<strong>dplyr</strong> and <strong>tibble</strong> to work with tabular data and the ‘data wrangling’ approach to coding.</li>
<li>
<strong>simtrial</strong> to enable simulations.</li>
<li>
<strong>survival</strong> to enable Cox proportional hazards estimation of the (average) hazard ratio for each simulation to compare with the approximation provided by the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> routine that computes an expected average hazard ratio for the trial (<span class="citation">Kalbfleisch and Prentice (1981)</span>, <span class="citation">Schemper, Wakounig, and Heinze (2009)</span>).</li>
<li>Hidden underneath this is the <code><a href="../reference/eEvents_df.html">gsDesign2::eEvents_df()</a></code> routine that provides expected event counts for each period and stratum where the hazard ratio differs. This is the basic calculation used in the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> routine.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/gsDesign2/">gsDesign2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keaven.github.io/gsDesign/" class="external-link">gsDesign</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://merck.github.io/simtrial/" class="external-link">simtrial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="single-stratum-non-proportional-hazards-example">Single stratum non-proportional hazards example<a class="anchor" aria-label="anchor" href="#single-stratum-non-proportional-hazards-example"></a>
</h2>
<div class="section level3">
<h3 id="design-scenario">Design scenario<a class="anchor" aria-label="anchor" href="#design-scenario"></a>
</h3>
<p>We set up the first scenario design parameters. Enrollment ramps up over the course of the first 4 months follow-up by a steady state enrollment thereafter. This will be adjusted proportionately to power the trial later. The control group has a piecewise exponential distribution with median 9 for the first 3 months and 18 thereafter. The hazard ratio of the experimental group versus control is 1 for the first 3 months followed by 0.55 thereafter.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enrollRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Stratum <span class="op">=</span> <span class="st">"All"</span>, <span class="co"># Note: this is done differently for multiple strata; see below!</span></span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">6</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">failRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Stratum <span class="op">=</span> <span class="st">"All"</span>,</span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">18</span><span class="op">)</span>,</span>
<span>  hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.55</span><span class="op">)</span>,</span>
<span>  dropoutRate <span class="op">=</span> <span class="fl">.001</span></span>
<span><span class="op">)</span></span>
<span><span class="va">totalDuration</span> <span class="op">&lt;-</span> <span class="fl">30</span></span></code></pre></div>
<p>Since there is a single stratum, we set <code>strata</code> to the default:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">strata</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>Stratum <span class="op">=</span> <span class="st">"All"</span>, p <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-average-hazard-ratio">Computing average hazard ratio<a class="anchor" aria-label="anchor" href="#computing-average-hazard-ratio"></a>
</h3>
<p>We compute an average hazard ratio using the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> (average hazard ratio) routine. We will modify enrollment rates proportionately below when the sample size is computed. This result is for the given enrollment rates which will be adjusted in our next step. However, since they will be adjusted proportionately with relative enrollment timing not changing, the average hazard ratio will not change. Approximations of statistical information under the null (<code>info0</code>) and alternate (<code>info</code>) hypotheses are provided here. Recall that the parameterization here is in terms of <span class="math inline">\(\log(HR)\)</span>, and, thus the information is intended to approximate 1 over the variance for the Cox regression coefficient for treatment effect; this will be checked with simulation later.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avehr</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">totalDuration</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">avehr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">30</td>
<td align="right">0.691</td>
<td align="right">58.131</td>
<td align="right">14.102</td>
<td align="right">14.533</td>
</tr></tbody>
</table>
<p>This result can be explained by the number of events observed before and after the first 3 months of treatment in each treatment group.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>    enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>    failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>    totalDuration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">totalDuration</span><span class="op">)</span>,</span>
<span>    simple <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">xx</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="left">Stratum</th>
<th align="right">t</th>
<th align="right">HR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">30</td>
<td align="left">All</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">22.248</td>
<td align="right">5.562</td>
<td align="right">5.562</td>
</tr>
<tr class="even">
<td align="right">30</td>
<td align="left">All</td>
<td align="right">3</td>
<td align="right">0.55</td>
<td align="right">35.883</td>
<td align="right">8.540</td>
<td align="right">8.971</td>
</tr>
</tbody>
</table>
<p>Now we can replicate the geometric average hazard ratio (AHR) computed using the <code><a href="../reference/AHR.html">AHR()</a></code> routine above. We compute the logarithm of each HR above and computed a weighted average weighting by the expected number of events under each hazard ratio. Exponentiating the resulting weighted average gives the geometric mean hazard ratio, which we label as AHR.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Events</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">HR</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="left">Stratum</th>
<th align="right">AHR</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">30</td>
<td align="left">All</td>
<td align="right">0.691</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="deriving-the-design">Deriving the design<a class="anchor" aria-label="anchor" href="#deriving-the-design"></a>
</h3>
<p>With this average hazard ratio, we use the call for <code><a href="https://keaven.github.io/gsDesign/reference/nSurvival.html" class="external-link">gsDesign::nEvents()</a></code> which uses the <span class="citation">Schoenfeld (1981)</span> approximation to derive a targeted number of events. All you need for this is the average hazard ratio from above, the randomization ratio (experimental/control), Type I error and Type II error (1 - power).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targetEvents</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">gsDesign</span><span class="fu">::</span><span class="fu"><a href="https://keaven.github.io/gsDesign/reference/nSurvival.html" class="external-link">nEvents</a></span><span class="op">(</span></span>
<span>    hr <span class="op">=</span> <span class="va">avehr</span><span class="op">$</span><span class="va">AHR</span>, <span class="co"># average hazard ratio computed above</span></span>
<span>    ratio <span class="op">=</span> <span class="fl">1</span>, <span class="co"># randomization ratio</span></span>
<span>    alpha <span class="op">=</span> <span class="fl">.025</span>, <span class="co"># 1-sided Type I error</span></span>
<span>    beta <span class="op">=</span> <span class="fl">.1</span> <span class="co"># Type II error (1-power)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">targetEvents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">targetEvents</span><span class="op">)</span></span>
<span><span class="va">targetEvents</span></span>
<span><span class="co">#&gt; [1] 309</span></span></code></pre></div>
<p>We also compute proportionately increase the enrollment rates to achieve this targeted number of events; we round up the number of events required to the next higher integer.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Update enrollRates to obtain targeted events</span></span>
<span><span class="va">enrollRates</span><span class="op">$</span><span class="va">rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">targetEvents</span><span class="op">)</span> <span class="op">/</span> <span class="va">avehr</span><span class="op">$</span><span class="va">Events</span> <span class="op">*</span> <span class="va">enrollRates</span><span class="op">$</span><span class="va">rate</span></span>
<span><span class="va">avehr</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">totalDuration</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">avehr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">30</td>
<td align="right">0.691</td>
<td align="right">309</td>
<td align="right">74.961</td>
<td align="right">77.25</td>
</tr></tbody>
</table>
<p>We also compute sample size, rounding up to the nearest even integer.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># round up sample size in both treatment groups</span></span>
<span><span class="va">sampleSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">enrollRates</span><span class="op">$</span><span class="va">rate</span> <span class="op">*</span> <span class="va">enrollRates</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="va">sampleSize</span></span>
<span><span class="co">#&gt; [1] 576</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="average-hazard-ratio-and-expected-event-accumulation-over-time">Average hazard ratio and expected event accumulation over time<a class="anchor" aria-label="anchor" href="#average-hazard-ratio-and-expected-event-accumulation-over-time"></a>
</h3>
<p>We examine the average hazard ratio as a function of trial duration with the modified enrollment required to power the trial. We also plot expected event accrual over time; although the graphs go through 40 months, recall that the targeted trial duration is 30 months. A key design consideration is selecting trial duration based on things like the degree of AHR improvement over time versus the urgency of completing the trial as quickly as possible, noting that the required sample size will decrease with longer follow-up.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avehrtbl</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">totalDuration</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">avehrtbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">AHR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Average HR"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Average HR as a function of study duration"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">48</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="AHRVignette_files/figure-html/avehrplot-1.png" width="624"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">avehrtbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">Events</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected events"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Expected event accumulation as a function of study duration"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">48</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="AHRVignette_files/figure-html/avehrplot-2.png" width="624"></p>
</div>
<div class="section level3">
<h3 id="simulation-to-verify-power">Simulation to verify power<a class="anchor" aria-label="anchor" href="#simulation-to-verify-power"></a>
</h3>
<p>We use function <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> to simplify setting up and executing a simulation to evaluate the sample size derivation above. Arguments for <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> are slightly different than the set-up that was used for the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> function used above. Thus, there is some reformatting of input parameters involved. One difference from the <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code> parameterization in <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> is that <code>block</code> is provided to specify fixed block randomization as opposed to <code>ratio</code> for <code><a href="../reference/AHR.html">gsDesign2::AHR()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># do simulations</span></span>
<span><span class="co"># Cut at targeted study duration</span></span>
<span><span class="va">results1</span> <span class="op">&lt;-</span> <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simfix</a></span><span class="op">(</span></span>
<span>  nsim <span class="op">=</span> <span class="va">nsim</span>,</span>
<span>  block <span class="op">=</span> <span class="va">block</span>,</span>
<span>  sampleSize <span class="op">=</span> <span class="va">sampleSize</span>,</span>
<span>  strata <span class="op">=</span> <span class="va">strata</span>,</span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="va">totalDuration</span>,</span>
<span>  targetEvents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">targetEvents</span><span class="op">)</span>,</span>
<span>  timingType <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># save(results1, file = './fixutes/results1.Rdata') # Save the data</span></span></code></pre></div>
<p>The following summarizes outcomes by the data cutoff chosen. Regardless of cutoff chosen, we see that the power approximates the targeted 90% quite well. The statistical information computed in the simulation is computed as one over the simulation variance of the Cox regression coefficient for treatment (i.e., the log hazard ratio).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"./fixtures/results1.Rdata"</span><span class="op">)</span> <span class="co"># loading the data previously saved</span></span>
<span></span>
<span><span class="va">results1</span><span class="op">$</span><span class="va">Positive</span> <span class="op">&lt;-</span> <span class="va">results1</span><span class="op">$</span><span class="va">Z</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">.025</span><span class="op">)</span></span>
<span><span class="va">results1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cut</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    Simulations <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, Power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Positive</span><span class="op">)</span>, sdDur <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Duration</span><span class="op">)</span>, Duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Duration</span><span class="op">)</span>,</span>
<span>    sdEvents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>, Events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>,</span>
<span>    HR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lnhr</span><span class="op">)</span><span class="op">)</span>, sdlnhr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">lnhr</span><span class="op">)</span>, info <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">sdlnhr</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="32%">
<col width="11%">
<col width="5%">
<col width="5%">
<col width="8%">
<col width="8%">
<col width="7%">
<col width="5%">
<col width="6%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">cut</th>
<th align="right">Simulations</th>
<th align="right">Power</th>
<th align="right">sdDur</th>
<th align="right">Duration</th>
<th align="right">sdEvents</th>
<th align="right">Events</th>
<th align="right">HR</th>
<th align="right">sdlnhr</th>
<th align="right">info</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Max(min follow-up, event cut)</td>
<td align="right">2000</td>
<td align="right">0.895</td>
<td align="right">0.983</td>
<td align="right">30.560</td>
<td align="right">7.050</td>
<td align="right">314.226</td>
<td align="right">0.692</td>
<td align="right">0.116</td>
<td align="right">73.830</td>
</tr>
<tr class="even">
<td align="left">Max(planned duration, event cut)</td>
<td align="right">2000</td>
<td align="right">0.895</td>
<td align="right">0.910</td>
<td align="right">30.551</td>
<td align="right">7.090</td>
<td align="right">314.164</td>
<td align="right">0.692</td>
<td align="right">0.116</td>
<td align="right">73.943</td>
</tr>
<tr class="odd">
<td align="left">Minimum follow-up</td>
<td align="right">2000</td>
<td align="right">0.888</td>
<td align="right">0.495</td>
<td align="right">30.024</td>
<td align="right">11.621</td>
<td align="right">310.146</td>
<td align="right">0.694</td>
<td align="right">0.117</td>
<td align="right">73.270</td>
</tr>
<tr class="even">
<td align="left">Planned duration</td>
<td align="right">2000</td>
<td align="right">0.886</td>
<td align="right">0.000</td>
<td align="right">30.000</td>
<td align="right">11.720</td>
<td align="right">309.958</td>
<td align="right">0.694</td>
<td align="right">0.117</td>
<td align="right">72.993</td>
</tr>
<tr class="odd">
<td align="left">Targeted events</td>
<td align="right">2000</td>
<td align="right">0.880</td>
<td align="right">1.595</td>
<td align="right">29.824</td>
<td align="right">0.000</td>
<td align="right">309.000</td>
<td align="right">0.694</td>
<td align="right">0.118</td>
<td align="right">71.832</td>
</tr>
</tbody>
</table>
<p>The column <code>HR</code> above is the exponentiated mean of the Cox regression coefficients (geometric mean of HR). We see that the <code>HR</code> estimate below matches the simulations above quite well. The column <code>info</code> here is the estimated statistical information under the alternate hypothesis, while <code>info0</code> is the estimate under the null hypothesis. The value of <code>info0</code> is 1/4 of the expected events calculated below. In this case, the information approximation under the alternate hypothesis appears slightly small, meaning that the asymptotic approximation used will overpower the trial. Nonetheless, the approximation for power appear quite good as noted above.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avehr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">30</td>
<td align="right">0.691</td>
<td align="right">309</td>
<td align="right">74.961</td>
<td align="right">77.25</td>
</tr></tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="different-proportional-hazards-by-strata">Different proportional hazards by strata<a class="anchor" aria-label="anchor" href="#different-proportional-hazards-by-strata"></a>
</h2>
<div class="section level3">
<h3 id="design-scenario-1">Design scenario<a class="anchor" aria-label="anchor" href="#design-scenario-1"></a>
</h3>
<p>We set up the design scenario parameter. We are limited here to simultaneous enrollment of strata since the <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code> routine uses <code><a href="https://merck.github.io/simtrial/reference/simPWSurv.html" class="external-link">simtrial::simPWSurv()</a></code> which is limited to this scenario. We specify three strata:</p>
<ul>
<li>High risk: 1/3 of the population with median time-to-event of 6 months and a treatment effect hazard ratio of 1.2.</li>
<li>Moderate risk: 1/2 of the population with median time-to-event of 9 months and a hazard ratio of 0.2.</li>
<li>Low risk: 1/6 of the population that is essentially cured in both arms (median 100, HR = 1).</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">strata</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>Stratum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"High"</span>, <span class="st">"Moderate"</span>, <span class="st">"Low"</span><span class="op">)</span>, p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">3</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">enrollRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Stratum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="st">"High"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="st">"Moderate"</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">18</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">failRates</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  Stratum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"High"</span>, <span class="st">"Moderate"</span>, <span class="st">"Low"</span><span class="op">)</span>,</span>
<span>  duration <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  failRate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">9</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>  hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  dropoutRate <span class="op">=</span> <span class="fl">.001</span></span>
<span><span class="op">)</span></span>
<span><span class="va">totalDuration</span> <span class="op">&lt;-</span> <span class="fl">36</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="computing-average-hazard-ratio-1">Computing average hazard ratio<a class="anchor" aria-label="anchor" href="#computing-average-hazard-ratio-1"></a>
</h3>
<p>Now we transform the enrollment rates to account for stratified population.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ahr2</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span><span class="va">enrollRates</span>, <span class="va">failRates</span>, <span class="va">totalDuration</span><span class="op">)</span></span>
<span><span class="va">ahr2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">36</td>
<td align="right">0.643</td>
<td align="right">53.413</td>
<td align="right">12.769</td>
<td align="right">13.353</td>
</tr></tbody>
</table>
<p>We examine the expected events by stratum.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span><span class="va">enrollRates</span>, <span class="va">failRates</span>, <span class="va">totalDuration</span>, simple <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">xx</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="left">Stratum</th>
<th align="right">t</th>
<th align="right">HR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">36</td>
<td align="left">High</td>
<td align="right">0</td>
<td align="right">1.200</td>
<td align="right">25.666</td>
<td align="right">6.414</td>
<td align="right">6.417</td>
</tr>
<tr class="even">
<td align="right">36</td>
<td align="left">Low</td>
<td align="right">0</td>
<td align="right">1.000</td>
<td align="right">1.997</td>
<td align="right">0.499</td>
<td align="right">0.499</td>
</tr>
<tr class="odd">
<td align="right">36</td>
<td align="left">Moderate</td>
<td align="right">0</td>
<td align="right">0.333</td>
<td align="right">25.750</td>
<td align="right">5.855</td>
<td align="right">6.438</td>
</tr>
</tbody>
</table>
<p>Getting the average of <code>log(HR)</code> weighted by <code>Events</code> and exponentiating, we get the overall <code>AHR</code> just derived.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>lnhr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Events</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">HR</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>, AHR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lnhr</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">lnhr</th>
<th align="right">AHR</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">-0.442</td>
<td align="right">0.643</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="deriving-the-design-1">Deriving the design<a class="anchor" aria-label="anchor" href="#deriving-the-design-1"></a>
</h3>
<p>We derive the sample size as before. We plan the sample size based on the average hazard ratio for the overall population and use that across strata. First, we derive the targeted events:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">targetEvents</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">gsDesign</span><span class="fu">::</span><span class="fu"><a href="https://keaven.github.io/gsDesign/reference/nSurvival.html" class="external-link">nEvents</a></span><span class="op">(</span></span>
<span>    hr <span class="op">=</span> <span class="va">ahr2</span><span class="op">$</span><span class="va">AHR</span>,</span>
<span>    ratio <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">.025</span>,</span>
<span>    beta <span class="op">=</span> <span class="fl">.1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">targetEvents</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">targetEvents</span><span class="op">)</span></span>
<span><span class="va">targetEvents</span></span>
<span><span class="co">#&gt; [1] 216</span></span></code></pre></div>
<p>Next, we adapt enrollment rates proportionately so that the trial will be powered for the targeted failure rates and follow-up duration.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enrollRates</span> <span class="op">&lt;-</span> <span class="va">enrollRates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">targetEvents</span> <span class="op">/</span> <span class="va">ahr2</span><span class="op">$</span><span class="va">Events</span> <span class="op">*</span> <span class="va">rate</span><span class="op">)</span></span>
<span><span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="va">totalDuration</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">36</td>
<td align="right">0.643</td>
<td align="right">216</td>
<td align="right">51.636</td>
<td align="right">54</td>
</tr></tbody>
</table>
<p>The targeted sample size, rounding up to an even integer, is:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampleSize</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">enrollRates</span><span class="op">$</span><span class="va">rate</span> <span class="op">*</span> <span class="va">enrollRates</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="va">sampleSize</span></span>
<span><span class="co">#&gt; [1] 340</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="average-hr-and-expected-event-accumulation-over-time">Average HR and expected event accumulation over time<a class="anchor" aria-label="anchor" href="#average-hr-and-expected-event-accumulation-over-time"></a>
</h3>
<p>Plotting the average hazard ratio as a function of study duration, we see that it improves considerably over the course of the study. We also plot expected event accumulation. As before, we plot for 10 months more than the planned study duration of 36 months to allow evaluation of event accumulation versus treatment effect for different trial durations.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avehrtbl</span> <span class="op">&lt;-</span> <span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">totalDuration</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">avehrtbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">AHR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Average HR"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Average HR as a function of study duration"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">48</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="AHRVignette_files/figure-html/avehrplot2-1.png" width="624"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">avehrtbl</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Time</span>, y <span class="op">=</span> <span class="va">Events</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Expected events"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Expected event accumulation as a function of study duration"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">48</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="AHRVignette_files/figure-html/avehrplot2-2.png" width="624"></p>
</div>
<div class="section level3">
<h3 id="simulation-to-verify-power-1">Simulation to verify power<a class="anchor" aria-label="anchor" href="#simulation-to-verify-power-1"></a>
</h3>
<p>We change the enrollment rates by stratum produced by <code><a href="https://keaven.github.io/gsDesign/reference/nSurv.html" class="external-link">gsDesign::nSurv()</a></code> to overall enrollment rates needed for <code><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simtrial::simfix()</a></code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">er</span> <span class="op">&lt;-</span> <span class="va">enrollRates</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Stratum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">rate</span><span class="op">)</span>, duration <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">last</a></span><span class="op">(</span><span class="va">duration</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">er</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">period</th>
<th align="right">rate</th>
<th align="right">duration</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">4.044</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">8.088</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">12.132</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">16.176</td>
<td align="right">18</td>
</tr>
</tbody>
</table>
<p>Now we simulate and summarize results. Once again, we see that the expected statistical information from the simulation is greater than what would be expected by the Schoenfeld approximation which is the expected events divided by 4.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results2</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">simtrial</span><span class="fu">::</span><span class="fu"><a href="https://merck.github.io/simtrial/reference/simfix.html" class="external-link">simfix</a></span><span class="op">(</span></span>
<span>    nsim <span class="op">=</span> <span class="va">nsim</span>,</span>
<span>    block <span class="op">=</span> <span class="va">block</span>,</span>
<span>    sampleSize <span class="op">=</span> <span class="va">sampleSize</span>,</span>
<span>    strata <span class="op">=</span> <span class="va">strata</span>,</span>
<span>    enrollRates <span class="op">=</span> <span class="va">er</span>,</span>
<span>    failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>    totalDuration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">totalDuration</span><span class="op">)</span>,</span>
<span>    targetEvents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">targetEvents</span><span class="op">)</span>,</span>
<span>    timingType <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># save(results2, file = './fixtures/results2.Rdata') # Save data</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"./fixtures/results2.Rdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results2</span><span class="op">$</span><span class="va">Positive</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">results2</span><span class="op">$</span><span class="va">Z</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">.025</span><span class="op">)</span></span>
<span><span class="va">results2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cut</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    Simulations <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, Power <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Positive</span><span class="op">)</span>, sdDur <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Duration</span><span class="op">)</span>, Duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Duration</span><span class="op">)</span>,</span>
<span>    sdEvents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>, Events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">Events</span><span class="op">)</span>,</span>
<span>    HR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lnhr</span><span class="op">)</span><span class="op">)</span>, sdlnhr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">lnhr</span><span class="op">)</span>, info <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">sdlnhr</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="32%">
<col width="11%">
<col width="5%">
<col width="5%">
<col width="8%">
<col width="8%">
<col width="7%">
<col width="5%">
<col width="6%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">cut</th>
<th align="right">Simulations</th>
<th align="right">Power</th>
<th align="right">sdDur</th>
<th align="right">Duration</th>
<th align="right">sdEvents</th>
<th align="right">Events</th>
<th align="right">HR</th>
<th align="right">sdlnhr</th>
<th align="right">info</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Max(min follow-up, event cut)</td>
<td align="right">2000</td>
<td align="right">0.895</td>
<td align="right">1.751</td>
<td align="right">36.952</td>
<td align="right">4.899</td>
<td align="right">219.416</td>
<td align="right">0.642</td>
<td align="right">0.137</td>
<td align="right">53.339</td>
</tr>
<tr class="even">
<td align="left">Max(planned duration, event cut)</td>
<td align="right">2000</td>
<td align="right">0.892</td>
<td align="right">1.529</td>
<td align="right">36.951</td>
<td align="right">4.988</td>
<td align="right">219.411</td>
<td align="right">0.641</td>
<td align="right">0.136</td>
<td align="right">53.724</td>
</tr>
<tr class="odd">
<td align="left">Minimum follow-up</td>
<td align="right">2000</td>
<td align="right">0.886</td>
<td align="right">1.139</td>
<td align="right">36.051</td>
<td align="right">8.595</td>
<td align="right">215.994</td>
<td align="right">0.644</td>
<td align="right">0.137</td>
<td align="right">53.503</td>
</tr>
<tr class="even">
<td align="left">Planned duration</td>
<td align="right">2000</td>
<td align="right">0.882</td>
<td align="right">0.000</td>
<td align="right">36.000</td>
<td align="right">8.918</td>
<td align="right">215.713</td>
<td align="right">0.644</td>
<td align="right">0.137</td>
<td align="right">53.530</td>
</tr>
<tr class="odd">
<td align="left">Targeted events</td>
<td align="right">2000</td>
<td align="right">0.879</td>
<td align="right">2.363</td>
<td align="right">36.060</td>
<td align="right">0.000</td>
<td align="right">216.000</td>
<td align="right">0.644</td>
<td align="right">0.138</td>
<td align="right">52.448</td>
</tr>
</tbody>
</table>
<p>Finally, compare the simulation results above to the asymptotic approximation below. The achieved power by simulation is just below the targeted 90%; noting that the simulation standard error is 0.006, the asymptotic approximation is quite good. Using the final cutoff that requires both the targeted events and minimum follow-up seems a reasonable convention to preserved targeted design power.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gsDesign2</span><span class="fu">::</span><span class="fu"><a href="../reference/AHR.html">AHR</a></span><span class="op">(</span></span>
<span>  enrollRates <span class="op">=</span> <span class="va">enrollRates</span>,</span>
<span>  failRates <span class="op">=</span> <span class="va">failRates</span>,</span>
<span>  totalDuration <span class="op">=</span> <span class="va">totalDuration</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Time</th>
<th align="right">AHR</th>
<th align="right">Events</th>
<th align="right">info</th>
<th align="right">info0</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">36</td>
<td align="right">0.643</td>
<td align="right">216</td>
<td align="right">51.636</td>
<td align="right">54</td>
</tr></tbody>
</table>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Kalbfleisch1981" class="csl-entry">
Kalbfleisch, John D, and Ross L Prentice. 1981. <span>“Estimation of the Average Hazard Ratio.”</span> <em>Biometrika</em> 68 (1): 105–12.
</div>
<div id="ref-Schemper2009" class="csl-entry">
Schemper, Michael, Samo Wakounig, and Georg Heinze. 2009. <span>“The Estimation of Average Hazard Ratios by Weighted Cox Regression.”</span> <em>Statistics in Medicine</em> 28 (19): 2473–89.
</div>
<div id="ref-Schoenfeld1981" class="csl-entry">
Schoenfeld, David. 1981. <span>“The Asymptotic Properties of Nonparametric Tests for Comparing Survival Distributions.”</span> <em>Biometrika</em> 68 (1): 316–19.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Keaven Anderson, Yilong Zhang. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6. <br>Copyright © 2022 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
