<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gsDesign2">
<title>Numerical Integration Non-Proportional Effect Size in Group Sequential Design • gsDesign2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Numerical Integration Non-Proportional Effect Size in Group Sequential Design">
<meta property="og:description" content="gsDesign2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gsDesign2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">Home</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/LittleBeannie/gsDesign2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="story_npe_integration_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Numerical Integration Non-Proportional Effect Size in Group Sequential Design</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/LittleBeannie/gsDesign2/blob/HEAD/vignettes/story_npe_integration.Rmd" class="external-link"><code>vignettes/story_npe_integration.Rmd</code></a></small>
      <div class="d-none name"><code>story_npe_integration.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>We have provided asymptotic distribution theory and notation for group sequential boundaries in <code>vignette("NPEbackground", package="gsdmvn")</code>.</p>
<p>This vignettes generalize computational algorithms provided in Chapter 19 of <span class="citation">Jennison and Turnbull (1999)</span> that are used to compute boundary crossing probabilities as well as derive boundaries for group sequential designs.</p>
</div>
<div class="section level3">
<h3 id="asymptotic-normal-and-boundary-crossing-probabilities">Asymptotic normal and boundary crossing probabilities<a class="anchor" aria-label="anchor" href="#asymptotic-normal-and-boundary-crossing-probabilities"></a>
</h3>
<p>We assume <span class="math inline">\(Z_1,\cdots,Z_K\)</span> has a multivariate normal distribution with variance for <span class="math inline">\(1\le k\le K\)</span> of <span class="math display">\[\hbox{Var}(Z_k) = 1\]</span> and the expected value is</p>
<p><span class="math display">\[E(Z_{k})= \sqrt{\mathcal{I}_k}\theta(t_{k})= \sqrt{n_k}E(\bar X_k) .\]</span></p>
</div>
<div class="section level3">
<h3 id="notation-for-boundary-crossing-probabilities">Notation for boundary crossing probabilities<a class="anchor" aria-label="anchor" href="#notation-for-boundary-crossing-probabilities"></a>
</h3>
<p>We use a shorthand notation in this section to have <span class="math inline">\(\theta\)</span> represent <span class="math inline">\(\theta()\)</span> and <span class="math inline">\(\theta=0\)</span> to represent <span class="math inline">\(\theta(t)\equiv 0\)</span> for all <span class="math inline">\(t\)</span>. We denote the probability of crossing the upper boundary at analysis <span class="math inline">\(k\)</span> without previously crossing a bound by</p>
<p><span class="math display">\[\alpha_{k}(\theta)=P_{\theta}(\{Z_{k}\geq b_{k}\}\cap_{j=1}^{i-1}\{a_{j}\le Z_{j}&lt; b_{j}\}),\]</span> <span class="math inline">\(k=1,2,\ldots,K.\)</span></p>
<p>Next, we consider analogous notation for the lower bound. For <span class="math inline">\(k=1,2,\ldots,K\)</span> denote the probability of crossing a lower bound at analysis <span class="math inline">\(k\)</span> without previously crossing any bound by</p>
<p><span class="math display">\[\beta_{k}(\theta)=P_{\theta}((Z_{k}&lt; a_{k}\}\cap_{j=1}^{k-1}\{ a_{j}\le Z_{j}&lt; b_{j}\}).\]</span> For symmetric testing for analysis <span class="math inline">\(k\)</span> we would have <span class="math inline">\(a_k= - b_k\)</span>, <span class="math inline">\(\beta_k(0)=\alpha_k(0),\)</span> <span class="math inline">\(k=1,2,\ldots,K\)</span>. The total lower boundary crossing probability for a trial is denoted by <span class="math display">\[\beta(\theta)\equiv\sum_{k=1}^{K}\beta_{k}(\theta).\]</span> Note that we can also set <span class="math inline">\(a_k= -\infty\)</span> for any or all analyses if a lower bound is not desired, <span class="math inline">\(k=1,2,\ldots,K\)</span>; thus, we will not use the <span class="math inline">\(\alpha^+(\theta)\)</span> notation here. For <span class="math inline">\(k&lt;K\)</span>, we can set <span class="math inline">\(b_k=\infty\)</span> where an upper bound is not desired. Obviously, for each <span class="math inline">\(k\)</span>, we want either <span class="math inline">\(a_k&gt;-\infty\)</span> or <span class="math inline">\(b_k&lt;\infty\)</span>.</p>
</div>
<div class="section level3">
<h3 id="recursive-algorithms-for-numerical-integration">Recursive algorithms for numerical integration<a class="anchor" aria-label="anchor" href="#recursive-algorithms-for-numerical-integration"></a>
</h3>
<p>We now provide a small update to the algorithm of Chapter 19 of <span class="citation">Jennison and Turnbull (1999)</span> to do the numerical integration required to compute the boundary crossing probabilites of the previous section and also identifying group sequential boundaries satisfying desired characteristics. The key to these calculations is the conditional power identitity in equation (1) above which allows building recursive numerical integration identities to enable simple, efficient numerical integration.</p>
<p>We define</p>
<p><span class="math display">\[g_1(z;\theta) = \frac{d}{dz}P(Z_1\le z) = \phi\left(z - \sqrt{\mathcal{I}_1}\theta(t_1)\right)\tag{2}\]</span></p>
<p>and for <span class="math inline">\(k=2,3,\ldots K\)</span> we recursively define the subdensity function</p>
<p><span class="math display">\[\begin{align}
g_k(z; \theta) &amp;= \frac{d}{dz}P_\theta(\{Z_k\le z\}\cap_{j=1}^{k-1}\{a_j\le Z_j&lt;b_j\}) \\
 &amp;=\int_{a_{k-1}}^{b_{k-1}}\frac{d}{dz}P_\theta(\{Z_k\le z |Z_{k-1}=z_{k-1}\})g_{k-1}(z_{k-1}; \theta)dz_{k-1}\\
 &amp;=\int_{a_{k-1}}^{b_{k-1}}f_k(z_{k-1},z;\theta)g_{k-1}(z_{k-1}; \theta)dz_{k-1}.\tag{3}
 \end{align}\]</span></p>
<p>The bottom line notation here is the same as on p. 347 in <span class="citation">Jennison and Turnbull (1999)</span>. However, <span class="math inline">\(f_k()\)</span> here takes a slightly different form.</p>
<p><span class="math display">\[\begin{align}
f_k(z_{k-1},z;\theta) &amp;=\frac{d}{dz}P_\theta(\{Z_k\le z |Z_{k-1}=z_{k-1}\})\\
 &amp;=\frac{d}{dz}P_\theta(B_k - B_{k-1} \le z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}})\\
 &amp;=\frac{d}{dz}\Phi\left(\frac{z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}}-\sqrt{\mathcal{I}_K}(t_k\theta(t_k)- t_{k-1}\theta(t_{k-1}))}{\sqrt{t_k-t_{k-1}}}\right)\\
 &amp;=\frac{\sqrt{t_k}}{\sqrt{t_k-t_{k-1}}}\phi\left(\frac{z\sqrt{t_k}-z_{k-1}\sqrt{t_{k-1}}-\sqrt{\mathcal{I}_K}(t_k\theta(t_k)- t_{k-1}\theta(t_{k-1}))}{\sqrt{t_k-t_{k-1}}}\right)\\
 &amp;=\frac{\sqrt{\mathcal{I}_k}}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\phi\left(\frac{z\sqrt{\mathcal{I}_k}-z_{k-1}\sqrt{\mathcal{I}_{k-1}}-(\mathcal{I}_k\theta(t_k)- \mathcal{I}_{k-1}\theta(t_{k-1}))}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\right).\tag{3}
\end{align}\]</span></p>
<p>We have worked towards this last line due to its comparability to equation (19.4) on p. 347 of <span class="citation">Jennison and Turnbull (1999)</span> which assumes <span class="math inline">\(\theta(t_k)=\theta\)</span> for some constant <span class="math inline">\(\theta\)</span>; we re-write that equation slightly here as:</p>
<p><span class="math display">\[f_k(z_{k-1},z;\theta) = \frac{\sqrt{\mathcal{I}_k}}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\phi\left(\frac{z\sqrt{\mathcal{I}_k}-z_{k-1}\sqrt{\mathcal{I}_{k-1}}-\theta(\mathcal{I}_k- \mathcal{I}_{k-1})}{\sqrt{\mathcal{I}_k-\mathcal{I}_{k-1}}}\right).\tag{4}\]</span> This is really the only difference in the computational algorithm for boundary crossing probabilities from the <span class="citation">Jennison and Turnbull (1999)</span> algorithm. Using the above recursive approach we can compute for <span class="math inline">\(k=1,2,\ldots,K\)</span></p>
<p><span class="math display">\[\alpha_{k}(\theta)=\int_{b_k}^\infty g_k(z;\theta)dz\tag{5}\]</span> and <span class="math display">\[\beta_{k}(\theta)=\int_{-\infty}^{a_k} g_k(z;\theta)dz.\tag{6}\]</span></p>
</div>
<div class="section level3">
<h3 id="deriving-spending-boundaries">Deriving spending boundaries<a class="anchor" aria-label="anchor" href="#deriving-spending-boundaries"></a>
</h3>
<p>We can now derive boundaries satisfying given boundary crossing probabilities using equations (2-6) above. Suppose for we have specified <span class="math inline">\(b_1,\ldots,b_{k-1}\)</span> and <span class="math inline">\(a_1,\ldots,a_{k-1}\)</span> and now wish to derive <span class="math inline">\(a_k\)</span> and <span class="math inline">\(b_k\)</span> such that equations (5) and (6) hold. We write the upper bound as a function of the probability of crossing we wish to derive.</p>
<p><span class="math display">\[\pi_k(b;\theta) = \int_b^\infty g_k(z;\theta)dz\]</span> <span class="math display">\[\pi_k^\prime(b;\theta) =\frac{d}{db}\pi_k(b;\theta)= -g_k(b; \theta).\tag{7}\]</span> If we have a value <span class="math inline">\(\pi_k(b^{(i)};\theta)\)</span> we can use a first order Taylor’s series expansion to approximate</p>
<p><span class="math display">\[\pi_k(b;\theta)\approx \pi_k(b^{(i)};\theta)+(b-b^{(i)})\pi_k^\prime(b^{(i)};\theta)\]</span> We set <span class="math inline">\(b^{(i+1)}\)</span> such that</p>
<p><span class="math display">\[\alpha_k(\theta)=\pi_k(b^{(i)}; \theta) + (b^{(i+1)}-b^{(i)})\pi^\prime(b^{(i)};\theta).\]</span></p>
<p>Solving for <span class="math inline">\(b^{(i+1)}\)</span> we have</p>
<p><span class="math display">\[b^{(i+i)} = b^{(i)} + \frac{\alpha_k(\theta) - \pi_k(b^{(i)};\theta)}{\pi_k^\prime(b^{(i)}; \theta)}= b^{(i)} - \frac{\alpha_k(\theta) - \pi_k(b^{(i)};\theta)}{g_k(b^{(i)}; \theta)}\tag{8}\]</span> and iterate until <span class="math inline">\(|b^{(i+1)}-b^{(i)}|&lt;\epsilon\)</span> for some tolerance level <span class="math inline">\(\epsilon&gt;0\)</span> and <span class="math inline">\(\pi_k(b^{(i+1)};\theta)-\alpha_k(\theta)\)</span> is suitably small. A simple starting value for any <span class="math inline">\(k\)</span> is</p>
<p><span class="math display">\[b^{(0)} = \Phi^{-1}(1- \alpha_k(\theta)) + \sqrt{\mathcal{I}_k}\theta(t_k).\tag{9}\]</span> Normally, <span class="math inline">\(b_k\)</span> will be calculated with <span class="math inline">\(\theta(t_k)=0\)</span> for <span class="math inline">\(k=1,2,\ldots,K\)</span> which simplifies the above. However, <span class="math inline">\(a_k\)</span> computed analogously will often use a non-zero <span class="math inline">\(\theta\)</span> to enable so-called <span class="math inline">\(\beta\)</span>-spending.</p>
</div>
<div class="section level3">
<h3 id="numerical-integration">Numerical integration<a class="anchor" aria-label="anchor" href="#numerical-integration"></a>
</h3>
<p>The numerical integration required to compute boundary probabilities and derive boundaries is the same as that defined in section 19.3 of <span class="citation">Jennison and Turnbull (1999)</span>. The single change is the replacement of the non-proportional effect size assumption of equation (3) above replacing the equivalent of equation (4) used for a constant effect size as in <span class="citation">Jennison and Turnbull (1999)</span>.</p>
<div class="section level4">
<h4 id="demonstrating-calculations">Demonstrating calculations<a class="anchor" aria-label="anchor" href="#demonstrating-calculations"></a>
</h4>
<p>We walk through how to perform the basic calculations above. The basic scenario will have one interim analysis in addition to the final analysis. We will target Type I error <span class="math inline">\(\alpha=0.025\)</span> and Type II error <span class="math inline">\(\beta = 0.1\)</span>, the latter corresponding to a target of 90% power. We will assume a power spending function with <span class="math inline">\(\rho=2\)</span> for both bounds. That is, for information fraction <span class="math inline">\(t\)</span>, the cumulative spending will be <span class="math inline">\(\alpha \times t^2\)</span> for the upper bound and <span class="math inline">\(\beta \times t^2\)</span> for the lower bound. Statistical information will be 1 for the first analysis and 4 for the final analysis, leading to information fraction <span class="math inline">\(t_1= 1/4, t_2=1\)</span> for the interim and final, respectively. We assume <span class="math inline">\(\theta_1 = .5\)</span>, <span class="math inline">\(\theta_3=1.5\)</span>.</p>
<ul>
<li>Set up overall study parameters</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Information for both null and alternative</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># information fraction</span></span>
<span><span class="va">timing</span> <span class="op">&lt;-</span> <span class="va">info</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">info</span><span class="op">)</span> </span>
<span><span class="co"># Type I error</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.025</span></span>
<span><span class="co"># Type II error (1 - power)</span></span>
<span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="co"># Cumulative alpha-spending at IA, Final</span></span>
<span><span class="va">alphaspend</span> <span class="op">&lt;-</span> <span class="va">alpha</span> <span class="op">*</span> <span class="va">timing</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co"># Cumulative beta-spending at IA, Final</span></span>
<span><span class="va">betaspend</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">timing</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co"># Average treatment effect at analyses</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span></code></pre></div>
<ul>
<li>Calculate interim bounds</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Upper bound under null hypothesis</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Lower bound under alternate hypothesis</span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Compare probability of crossing vs target for bounds:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Upper bound ="</span>, <span class="va">b1</span>, <span class="st">"Target spend ="</span>, <span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    <span class="st">"Actual spend ="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span>, lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Upper bound = 2.955167 Target spend = 0.0015625 Actual spend = 0.0015625</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Lower bound under alternate hypothesis</span></span>
<span><span class="va">a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Compare probability of crossing vs target for bounds:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Lower bound ="</span>, <span class="va">a1</span>, <span class="st">"Target spend ="</span>, <span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    <span class="st">"Actual spend ="</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Lower bound = -1.997705 Target spend = 0.00625 Actual spend = 0.00625</span></span></code></pre></div>
<ul>
<li>Set up numerical integration grid for next (final) analysis</li>
</ul>
<p>We set up a table for numerical integration over the continuation region which we can subsequently use to compute boundary crossing probabilities for bounds at the second interim analysis. We begin with the null hypothesis. The columns in the resulting table are - <code>z</code> - <span class="math inline">\(Z\)</span>-values for the grid; recall that each interim test statistic is normally distributed with variance 1 - <code>w</code> - weights for numerical integration - <code>h</code> - weights <code>w</code> times the normal density that can be used for numerical integration; we will demonstrate use below</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up grid over continuation region</span></span>
<span><span class="co"># Null hypothesis</span></span>
<span><span class="va">grid1_0</span> <span class="op">&lt;-</span> <span class="fu">h1</span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">a1</span>, b <span class="op">=</span> <span class="va">b1</span><span class="op">)</span></span>
<span><span class="va">grid1_0</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $z</span></span>
<span><span class="co">#&gt;   [1] -1.99770547 -1.95718607 -1.91666667 -1.87500000 -1.83333333 -1.79166667</span></span>
<span><span class="co">#&gt;   [7] -1.75000000 -1.70833333 -1.66666667 -1.62500000 -1.58333333 -1.54166667</span></span>
<span><span class="co">#&gt;  [13] -1.50000000 -1.45833333 -1.41666667 -1.37500000 -1.33333333 -1.29166667</span></span>
<span><span class="co">#&gt;  [19] -1.25000000 -1.20833333 -1.16666667 -1.12500000 -1.08333333 -1.04166667</span></span>
<span><span class="co">#&gt;  [25] -1.00000000 -0.95833333 -0.91666667 -0.87500000 -0.83333333 -0.79166667</span></span>
<span><span class="co">#&gt;  [31] -0.75000000 -0.70833333 -0.66666667 -0.62500000 -0.58333333 -0.54166667</span></span>
<span><span class="co">#&gt;  [37] -0.50000000 -0.45833333 -0.41666667 -0.37500000 -0.33333333 -0.29166667</span></span>
<span><span class="co">#&gt;  [43] -0.25000000 -0.20833333 -0.16666667 -0.12500000 -0.08333333 -0.04166667</span></span>
<span><span class="co">#&gt;  [49]  0.00000000  0.04166667  0.08333333  0.12500000  0.16666667  0.20833333</span></span>
<span><span class="co">#&gt;  [55]  0.25000000  0.29166667  0.33333333  0.37500000  0.41666667  0.45833333</span></span>
<span><span class="co">#&gt;  [61]  0.50000000  0.54166667  0.58333333  0.62500000  0.66666667  0.70833333</span></span>
<span><span class="co">#&gt;  [67]  0.75000000  0.79166667  0.83333333  0.87500000  0.91666667  0.95833333</span></span>
<span><span class="co">#&gt;  [73]  1.00000000  1.04166667  1.08333333  1.12500000  1.16666667  1.20833333</span></span>
<span><span class="co">#&gt;  [79]  1.25000000  1.29166667  1.33333333  1.37500000  1.41666667  1.45833333</span></span>
<span><span class="co">#&gt;  [85]  1.50000000  1.54166667  1.58333333  1.62500000  1.66666667  1.70833333</span></span>
<span><span class="co">#&gt;  [91]  1.75000000  1.79166667  1.83333333  1.87500000  1.91666667  1.95833333</span></span>
<span><span class="co">#&gt;  [97]  2.00000000  2.04166667  2.08333333  2.12500000  2.16666667  2.20833333</span></span>
<span><span class="co">#&gt; [103]  2.25000000  2.29166667  2.33333333  2.37500000  2.41666667  2.45833333</span></span>
<span><span class="co">#&gt; [109]  2.50000000  2.54166667  2.58333333  2.62500000  2.66666667  2.70833333</span></span>
<span><span class="co">#&gt; [115]  2.75000000  2.79166667  2.83333333  2.87500000  2.91666667  2.93591676</span></span>
<span><span class="co">#&gt; [121]  2.95516685</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $w</span></span>
<span><span class="co">#&gt;   [1] 0.013506468 0.054025872 0.027395357 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;   [7] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [13] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [19] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [25] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [31] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [37] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [43] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [49] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [55] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [61] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [67] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [73] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [79] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [85] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [91] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt;  [97] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt; [103] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt; [109] 0.027777778 0.055555556 0.027777778 0.055555556 0.027777778 0.055555556</span></span>
<span><span class="co">#&gt; [115] 0.027777778 0.055555556 0.027777778 0.055555556 0.020305586 0.025666787</span></span>
<span><span class="co">#&gt; [121] 0.006416697</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $h</span></span>
<span><span class="co">#&gt;   [1] 7.325795e-04 3.174772e-03 1.741296e-03 3.821460e-03 2.064199e-03</span></span>
<span><span class="co">#&gt;   [6] 4.452253e-03 2.396592e-03 5.151272e-03 2.763254e-03 5.918793e-03</span></span>
<span><span class="co">#&gt;  [11] 3.163964e-03 6.753608e-03 3.597711e-03 7.652841e-03 4.062610e-03</span></span>
<span><span class="co">#&gt;  [16] 8.611793e-03 4.555835e-03 9.623842e-03 5.073586e-03 1.068040e-02</span></span>
<span><span class="co">#&gt;  [21] 5.611075e-03 1.177092e-02 6.162560e-03 1.288302e-02 6.721409e-03</span></span>
<span><span class="co">#&gt;  [26] 1.400261e-02 7.280204e-03 1.511417e-02 7.830885e-03 1.620106e-02</span></span>
<span><span class="co">#&gt;  [31] 8.364929e-03 1.724594e-02 8.873556e-03 1.823116e-02 9.347967e-03</span></span>
<span><span class="co">#&gt;  [36] 1.913930e-02 9.779592e-03 1.995361e-02 1.016034e-02 2.065862e-02</span></span>
<span><span class="co">#&gt;  [41] 1.048287e-02 2.124051e-02 1.074078e-02 2.168766e-02 1.092888e-02</span></span>
<span><span class="co">#&gt;  [46] 2.199098e-02 1.104332e-02 2.214423e-02 1.108173e-02 2.214423e-02</span></span>
<span><span class="co">#&gt;  [51] 1.104332e-02 2.199098e-02 1.092888e-02 2.168766e-02 1.074078e-02</span></span>
<span><span class="co">#&gt;  [56] 2.124051e-02 1.048287e-02 2.065862e-02 1.016034e-02 1.995361e-02</span></span>
<span><span class="co">#&gt;  [61] 9.779592e-03 1.913930e-02 9.347967e-03 1.823116e-02 8.873556e-03</span></span>
<span><span class="co">#&gt;  [66] 1.724594e-02 8.364929e-03 1.620106e-02 7.830885e-03 1.511417e-02</span></span>
<span><span class="co">#&gt;  [71] 7.280204e-03 1.400261e-02 6.721409e-03 1.288302e-02 6.162560e-03</span></span>
<span><span class="co">#&gt;  [76] 1.177092e-02 5.611075e-03 1.068040e-02 5.073586e-03 9.623842e-03</span></span>
<span><span class="co">#&gt;  [81] 4.555835e-03 8.611793e-03 4.062610e-03 7.652841e-03 3.597711e-03</span></span>
<span><span class="co">#&gt;  [86] 6.753608e-03 3.163964e-03 5.918793e-03 2.763254e-03 5.151272e-03</span></span>
<span><span class="co">#&gt;  [91] 2.396592e-03 4.452253e-03 2.064199e-03 3.821460e-03 1.765603e-03</span></span>
<span><span class="co">#&gt;  [96] 3.257338e-03 1.499749e-03 2.757277e-03 1.265110e-03 2.317833e-03</span></span>
<span><span class="co">#&gt; [101] 1.059795e-03 1.934941e-03 8.816570e-04 1.604123e-03 7.283858e-04</span></span>
<span><span class="co">#&gt; [106] 1.320661e-03 5.975956e-04 1.079765e-03 4.868972e-04 8.767006e-04</span></span>
<span><span class="co">#&gt; [111] 3.939593e-04 7.068990e-04 3.165552e-04 5.660405e-04 2.525990e-04</span></span>
<span><span class="co">#&gt; [116] 4.501131e-04 2.001694e-04 3.554511e-04 1.151506e-04 1.375807e-04</span></span>
<span><span class="co">#&gt; [121] 3.249917e-05</span></span></code></pre></div>
<p>The probability of not crossing a bound under the null hypothesis is computed as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">probH0continue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid1_0</span><span class="op">$</span><span class="va">h</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Probability of continuing trial under null hypothesis\n"</span>,</span>
<span>    <span class="st">" Using numerical integration:"</span>, <span class="va">probH0continue</span>, </span>
<span>    <span class="st">"\n  Using normal cdf:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Probability of continuing trial under null hypothesis</span></span>
<span><span class="co">#&gt;   Using numerical integration: 0.9755632 </span></span>
<span><span class="co">#&gt;   Using normal cdf: 0.9755632</span></span></code></pre></div>
<p>We now set up numerical integration grid under the alternate hypothesis and the compute continuation probability.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid1_1</span> <span class="op">&lt;-</span> <span class="fu">h1</span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">a1</span>, b <span class="op">=</span> <span class="va">b1</span><span class="op">)</span></span>
<span><span class="va">probH1continue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid1_1</span><span class="op">$</span><span class="va">h</span><span class="op">)</span> </span>
<span><span class="va">h1mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Probability of continuing trial under alternate hypothesis\n"</span>,</span>
<span>    <span class="st">" Using numerical integration:"</span>, <span class="va">probH1continue</span>, </span>
<span>    <span class="st">"\n  Using normal cdf:"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">b1</span>, mean <span class="op">=</span> <span class="va">h1mean</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">a1</span>, <span class="va">h1mean</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Probability of continuing trial under alternate hypothesis</span></span>
<span><span class="co">#&gt;   Using numerical integration: 0.986709 </span></span>
<span><span class="co">#&gt;   Using normal cdf: 0.986709</span></span></code></pre></div>
<ul>
<li>Compute initial iteration for analysis 2 bounds</li>
</ul>
<p>The initial estimate of the second analysis bounds are computed the same way as the actual first analysis bounds.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Upper bound under null hypothesis</span></span>
<span><span class="co"># incremental spend</span></span>
<span><span class="va">spend0</span> <span class="op">&lt;-</span> <span class="va">alphaspend</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">alphaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co"># H0 bound at 2nd analysis; 1st approximation</span></span>
<span><span class="va">b2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">spend0</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Lower bound under alternate hypothesis</span></span>
<span><span class="va">spend1</span> <span class="op">&lt;-</span> <span class="va">betaspend</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">betaspend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">a2_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="va">spend1</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial bound approximation for 2nd analysis\n ("</span>,</span>
<span>    <span class="va">a2_0</span>, <span class="st">", "</span>, <span class="va">b2_0</span>,<span class="st">")\n"</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial bound approximation for 2nd analysis</span></span>
<span><span class="co">#&gt;  (1.681989, 1.987428)</span></span></code></pre></div>
<ul>
<li>Compute actual boundary crossing probabilities with initial approximations</li>
</ul>
<p>To get actual boundary crossing probabilities at the second analysis, we update our numerical integration grids. Under the null hypothesis, we need to update to the interval above <code>b2_0</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Upper rejection region grid under H0</span></span>
<span><span class="va">grid2_0</span> <span class="op">&lt;-</span> <span class="fu">hupdate</span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">b2_0</span>, b <span class="op">=</span> <span class="cn">Inf</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_0</span><span class="op">)</span></span>
<span><span class="va">pupper_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid2_0</span><span class="op">$</span><span class="va">h</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Upper spending at analysis 2\n Target:"</span>, <span class="va">spend0</span>, <span class="st">"\n Using initial bound approximation:"</span>,</span>
<span>    <span class="va">pupper_0</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Upper spending at analysis 2</span></span>
<span><span class="co">#&gt;  Target: 0.0234375 </span></span>
<span><span class="co">#&gt;  Using initial bound approximation: 0.02290683</span></span></code></pre></div>
<p>To get a first order Taylor’s series approximation to update this bound, we need the derivative of the above probability with respect to the Z-value cutoff. This was given above as the subdensity computed in the grid. As before, the grid contains the numerical integration weight in <code>w</code> and that weight times the subdensity in <code>h</code>. Thus, to get the subdensity at the bound, which is the estimated derivative in the boundary crossing probability, we compute:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First point in grid is at bound</span></span>
<span><span class="co"># Compute derivative</span></span>
<span><span class="va">dpdb2</span> <span class="op">&lt;-</span> <span class="va">grid2_0</span><span class="op">$</span><span class="va">h</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">grid2_0</span><span class="op">$</span><span class="va">w</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co"># Compute difference between target and actual bound crossing probability</span></span>
<span><span class="va">pdiff</span> <span class="op">&lt;-</span> <span class="va">spend0</span> <span class="op">-</span> <span class="va">pupper_0</span></span>
<span><span class="co"># Taylor's series update</span></span>
<span><span class="va">b2_1</span> <span class="op">&lt;-</span> <span class="va">b2_0</span> <span class="op">-</span> <span class="va">pdiff</span> <span class="op">/</span> <span class="va">dpdb2</span></span>
<span><span class="co"># Compute boundary crossing probability at updated bound</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original bound approximation:"</span>, <span class="va">b2_0</span>, </span>
<span>    <span class="st">"\nUpdated bound approximation:"</span>, <span class="va">b2_1</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">#&gt; Original bound approximation: 1.987428 </span></span>
<span><span class="co">#&gt; Updated bound approximation: 1.977726</span></span>
<span><span class="va">grid2_0</span> <span class="op">&lt;-</span> <span class="fu">hupdate</span><span class="op">(</span>theta <span class="op">=</span> <span class="fl">0</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="va">b2_1</span>, b <span class="op">=</span> <span class="cn">Inf</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_0</span><span class="op">)</span></span>
<span><span class="va">pupper_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid2_0</span><span class="op">$</span><span class="va">h</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOriginal boundary crossing probability:"</span>, <span class="va">pupper_0</span>, </span>
<span>    <span class="st">"\nUpdated boundary crossing probability:"</span>, <span class="va">pupper_1</span>,</span>
<span>    <span class="st">"\nTarget:"</span>, <span class="va">spend0</span>, <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original boundary crossing probability: 0.02290683 </span></span>
<span><span class="co">#&gt; Updated boundary crossing probability: 0.02344269 </span></span>
<span><span class="co">#&gt; Target: 0.0234375</span></span></code></pre></div>
<p>We see that the Taylor’s series update has gotten us substantially closer to the targeted boundary probability. We now update the lower bound in an analogous fashion.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Lower rejection region grid under H1</span></span>
<span><span class="va">grid2_1</span> <span class="op">&lt;-</span> <span class="fu">hupdate</span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="va">a2_0</span>, </span>
<span>                   thetam1 <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_1</span><span class="op">)</span></span>
<span><span class="va">plower_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid2_1</span><span class="op">$</span><span class="va">h</span><span class="op">)</span></span>
<span><span class="co"># Last point in grid is at bound</span></span>
<span><span class="co"># Compute derivative</span></span>
<span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">grid2_1</span><span class="op">$</span><span class="va">h</span><span class="op">)</span></span>
<span><span class="va">dpda2</span> <span class="op">&lt;-</span> <span class="va">grid2_1</span><span class="op">$</span><span class="va">h</span><span class="op">[</span><span class="va">indx</span><span class="op">]</span> <span class="op">/</span> <span class="va">grid2_1</span><span class="op">$</span><span class="va">w</span><span class="op">[</span><span class="va">indx</span><span class="op">]</span></span>
<span><span class="co"># Compute difference between target and actual bound crossing probability</span></span>
<span><span class="va">pdiff</span> <span class="op">&lt;-</span> <span class="va">spend1</span> <span class="op">-</span> <span class="va">plower_0</span></span>
<span><span class="co"># Taylor's series update</span></span>
<span><span class="va">a2_1</span> <span class="op">&lt;-</span> <span class="va">a2_0</span> <span class="op">+</span> <span class="va">pdiff</span> <span class="op">/</span> <span class="va">dpda2</span></span>
<span><span class="co"># Compute boundary crossing probability at updated bound</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Original bound approximation:"</span>, <span class="va">a2_0</span>, </span>
<span>    <span class="st">"\nUpdated bound approximation:"</span>, <span class="va">a2_1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original bound approximation: 1.681989 </span></span>
<span><span class="co">#&gt; Updated bound approximation: 1.702596</span></span>
<span></span>
<span><span class="va">grid2_1</span> <span class="op">&lt;-</span> <span class="fu">hupdate</span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, I <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, a <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, b <span class="op">=</span> <span class="va">a2_1</span>, </span>
<span>                   thetam1 <span class="op">=</span> <span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, Im1 <span class="op">=</span> <span class="va">info</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, gm1 <span class="op">=</span> <span class="va">grid1_1</span><span class="op">)</span></span>
<span><span class="va">plower_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">grid2_1</span><span class="op">$</span><span class="va">h</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nOriginal boundary crossing probability:"</span>, <span class="va">plower_0</span>, </span>
<span>    <span class="st">"\nUpdated boundary crossing probability:"</span>, <span class="va">plower_1</span>,</span>
<span>    <span class="st">"\nTarget:"</span>, <span class="va">spend1</span>, <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Original boundary crossing probability: 0.09035972 </span></span>
<span><span class="co">#&gt; Updated boundary crossing probability: 0.09379707 </span></span>
<span><span class="co">#&gt; Target: 0.09375</span></span></code></pre></div>
<ul>
<li>Confirm with <code><a href="../reference/gs_power_npe.html">gs_power_npe()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gs_power_npe.html">gs_power_npe</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">theta</span>, theta1 <span class="op">=</span> <span class="va">theta</span>, info <span class="op">=</span> <span class="va">info</span>, binding <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>             upper <span class="op">=</span> <span class="va">gs_spending_bound</span>,</span>
<span>             upar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://keaven.github.io/gsDesign/reference/sfPower.html" class="external-link">sfPower</a></span>, total_spend <span class="op">=</span> <span class="fl">0.025</span>, param <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>             lower <span class="op">=</span> <span class="va">gs_spending_bound</span>,</span>
<span>             lpar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sf <span class="op">=</span> <span class="fu">gsDesign</span><span class="fu">::</span><span class="va"><a href="https://keaven.github.io/gsDesign/reference/sfPower.html" class="external-link">sfPower</a></span>, total_spend <span class="op">=</span> <span class="fl">0.1</span>, param <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 10</span></span></span>
<span><span class="co">#&gt;   Analysis Bound     Z Probability theta theta1    IF  info info0 info1</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        1 Upper  2.96     0.007<span style="text-decoration: underline;">04</span>   0.5    0.5  0.25     1     1     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>        2 Upper  1.98     0.845     1.5    1.5  1        4     4     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>        1 Lower -<span style="color: #BB0000;">2.00</span>     0.006<span style="text-decoration: underline;">25</span>   0.5    0.5  0.25     1     1     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>        2 Lower  1.70     0.100     1.5    1.5  1        4     4     4</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-JTBook">
<p>Jennison, Christopher, and Bruce W Turnbull. 1999. <em>Group Sequential Methods with Applications to Clinical Trials</em>. CRC Press.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Keaven Anderson, Yilong Zhang, Yujie Zhao. Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6. <br>Copyright © 2022 Merck &amp; Co., Inc., Rahway, NJ, USA and its affiliates. All rights reserved.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p><span></span></p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
